{% extends "base.html" %}
{% block content %}
<h2>生成详情 #{{ g.id }}</h2>
<p><strong>提示词：</strong>{{ g.prompt }}</p>
<p><strong>Provider：</strong>{{ g.provider }} | <strong>模式：</strong>{{ g.mode }} | <strong>耗时(ms)：</strong>{{ g.duration_ms }} | <strong>缓存：</strong>{{ g.cache_hit }}</p>

{% if g.model_path %}
<article>
  <header>OBJ 简要统计</header>
  <ul>
    <li>顶点：{{ stats.vertices }}</li>
    <li>面数：{{ stats.faces }}</li>
    <li>文件大小：{{ stats.file_size_kb }} KB</li>
    <li>下载：<a href="{{ url_for('download', filename=g.model_path|basename) }}">下载 OBJ</a></li>
  </ul>
</article>

<article>
  <header>在线预览（Three.js）</header>
  <div id="viewer" style="height: 420px; border: 1px solid #ddd;"></div>
  <p class="code">注意：此处使用 three.js OBJLoader 在线拉取 OBJ 文件进行预览。</p>
</article>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.161.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.161.0/examples/jsm/controls/OrbitControls.js';
import { OBJLoader } from 'https://unpkg.com/three@0.161.0/examples/jsm/loaders/OBJLoader.js';

const container = document.getElementById('viewer');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf7f7f7);
const camera = new THREE.PerspectiveCamera(45, container.clientWidth / 420, 0.1, 1000);
camera.position.set(2,2,2);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(container.clientWidth, 420);
container.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);

const light1 = new THREE.DirectionalLight(0xffffff, 0.9); light1.position.set(3,3,3); scene.add(light1);
const ambient = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambient);

const loader = new OBJLoader();
loader.load('{{ url_for("static", filename="models/" + (g.model_path|basename)) }}', (obj) => {
  // Auto scale & center
  new THREE.Box3().setFromObject(obj).getCenter(obj.position).multiplyScalar(-1);
  scene.add(obj);
}, undefined, (err)=>{
  console.error(err);
});

function onResize(){
  const w = container.clientWidth; const h = 420;
  camera.aspect = w / h; camera.updateProjectionMatrix();
  renderer.setSize(w, h);
}
window.addEventListener('resize', onResize);

(function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
})();
</script>
{% endif %}

<h3>提交反馈</h3>
<form action="{{ url_for('feedback', gen_id=g.id) }}" method="post">
  <label>评分（1-5）
    <input type="number" name="rating" min="1" max="5" required>
  </label>
  <fieldset>
    <legend>问题（可多选）</legend>
    <label><input type="checkbox" name="issues" value="几何失真">几何失真</label>
    <label><input type="checkbox" name="issues" value="纹理质量差">纹理质量差</label>
    <label><input type="checkbox" name="issues" value="拓扑不干净">拓扑不干净</label>
    <label><input type="checkbox" name="issues" value="与提示词不一致">与提示词不一致</label>
    <label><input type="checkbox" name="issues" value="面数过高/过低">面数过高/过低</label>
  </fieldset>
  <label>备注
    <textarea name="comment" rows="3" placeholder="还有什么想说的？"></textarea>
  </label>
  <button type="submit">提交反馈</button>
</form>

{% if feedbacks %}
<h3>历史反馈</h3>
<ul>
  {% for f in feedbacks %}
    <li>评分 {{ f.rating }} · {{ f.issues }} · {{ f.comment }}</li>
  {% endfor %}
</ul>
{% endif %}

{% endblock %}
